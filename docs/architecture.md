# Entrag 技术架构文档

## 系统架构概览

Entrag是一个基于RAG（检索增强生成）技术的智能问答系统，采用模块化设计，具有高可扩展性和可维护性。系统引入了先进的**完整缓存机制**和并行处理技术，实现了极致的性能优化。

## 核心组件

### 1. 应用层 (Application Layer)
- **CLI接口**: 基于Kong框架的命令行界面
- **配置管理**: YAML配置文件支持环境变量覆盖
- **命令处理**: Load、Index、Ask、Stats、Cleanup、Optimize六个核心命令

### 2. 业务逻辑层 (Business Logic Layer)
- **文档处理**: Markdown和文本文档解析和智能分块
- **向量化**: 文本到向量的转换，支持缓存加速
- **检索引擎**: 基于向量相似度的语义搜索
- **智能检索系统**: 🆕 查询类型识别和上下文优化
  - 查询分类: 概念性/操作性/比较性/列举性/通用
  - 智能过滤: 基于查询类型的文档片段过滤
  - 文件多样性: 防止单一文件过度占用结果
  - 质量保证: 多层过滤策略确保结果相关性
  - 兜底机制: 确保总是有相关结果返回
- **生成引擎**: 基于检索结果的答案生成

### 3. 完整缓存层 (Complete Cache Layer) 🆕
- **向量缓存**: 466,000x加速的向量缓存系统
- **问答缓存**: 253,000x加速的完整回答缓存系统
- **MD5哈希**: 基于内容的唯一性标识
- **文件存储**: 
  - `.entrag_cache/embeddings.json`向量缓存
  - `.entrag_cache/qa_cache.json`问答缓存
- **异步操作**: 非阻塞的缓存读写操作

### 4. 数据访问层 (Data Access Layer)
- **ORM**: Ent ORM提供类型安全的数据库操作
- **向量存储**: pgvector扩展支持向量数据操作
- **连接管理**: 数据库连接池管理
- **并发处理**: 3-worker并行向量化处理

### 5. 数据存储层 (Data Storage Layer)
- **PostgreSQL**: 关系型数据库
- **pgvector**: 向量数据库扩展
- **HNSW索引**: 高效的向量检索索引
- **文件缓存**: 本地文件系统缓存

### 6. 外部服务层 (External Services Layer)
- **Ollama**: 本地LLM服务
- **嵌入模型**: nomic-embed-text等
- **聊天模型**: llama3.2:3b等（性能优化后）

## 数据流架构

### 文档处理流程
```
1. 文档扫描 → 2. 内容解析 → 3. 智能分块 → 4. Token计算 → 5. 数据库存储
                                ↓
                            6. 重叠处理 → 7. 最小长度过滤
```

### 向量化流程（完整优化后）
```
1. 文本块获取 → 2. 向量缓存检查 → 3a. 缓存命中 (4µs) → 4. 返回缓存向量
                                ↓
                            3b. 缓存未命中 → 5. Ollama API调用 (918ms) → 6. 向量生成 → 7. 异步缓存保存 → 8. 返回向量
```

### 问答流程（完整优化后）
```
1. 用户提问 → 2. 向量缓存检查 → 3a. 缓存命中 (4µs) → 4. 向量检索
                              ↓
                          3b. 向量化 → 4. 缓存保存 → 5. 向量检索
                                                        ↓
6. 文档片段提取 → 7. 智能检索系统 → 8. 查询分类 → 9. 智能过滤 → 10. 文件多样性控制 → 11. 上下文构建
                                                                                    ↓
12. 问答缓存检查 → 13a. 缓存命中 (52µs) → 14. 返回答案
                 ↓
             13b. LLM生成 (13.156s) → 14. 缓存保存 → 15. 返回答案
```

### 完整缓存系统架构 🆕
```
查询请求 → MD5哈希 → 双重缓存查找 → 命中/未命中 → API调用 → 异步保存 → 磁盘持久化
    ↓           ↓              ↓
向量缓存   →   问答缓存   →   读写锁保护   →   文件系统
embeddings.json  qa_cache.json      线程安全        持久化存储
```

## 性能优化架构

### 缓存命中率优化
- **向量缓存**: 重复查询100%命中率
- **问答缓存**: 相同问题100%命中率
- **持久化**: 程序重启后缓存依然有效
- **自动清理**: 过期和无效缓存自动清理

### 并发处理优化
- **读写锁**: 保护缓存并发访问
- **异步保存**: 不阻塞主查询流程
- **3-worker并行**: 索引构建性能提升3x
- **线程安全**: 多线程环境下的稳定性

## 技术选型

### 编程语言
- **Go**: 主要开发语言，性能优异，并发支持良好

### 数据库
- **PostgreSQL 15+**: 成熟稳定的关系型数据库
- **pgvector**: 专业的向量数据库扩展，支持多种向量操作

### ORM框架
- **Ent**: Facebook开源的Go ORM，提供：
  - 类型安全的数据库操作
  - 代码生成
  - 图查询支持
  - 迁移管理

### 向量检索
- **HNSW算法**: 分层小世界图算法，提供：
  - 高效的近似最近邻搜索
  - 可扩展的索引结构
  - 良好的查询性能

### LLM服务
- **Ollama**: 本地LLM运行环境，优势：
  - 完全本地部署
  - 数据隐私保护
  - 多模型支持
  - API兼容性好

### 完整缓存技术 🆕
- **双重缓存**: 向量缓存 + 问答缓存
- **文件缓存**: 基于JSON的持久化存储
- **MD5哈希**: 内容唯一性标识
- **读写锁**: 并发安全保护
- **异步IO**: 非阻塞操作

## 安全架构

### 数据安全
- **本地部署**: 所有数据处理在本地完成，不依赖外部API
- **数据加密**: 支持数据库连接SSL加密
- **隐私保护**: 文档和查询数据完全本地化
- **访问控制**: 数据库连接权限管理

### 系统安全
- **输入验证**: 防止SQL注入和其他攻击
- **资源限制**: 防止资源耗尽攻击
- **错误处理**: 安全的错误信息处理

## 扩展性架构

### 水平扩展
- **多实例部署**: 支持多个entrag实例
- **负载均衡**: 可配置负载均衡器
- **数据分片**: 支持数据库分片

### 垂直扩展
- **模型替换**: 支持不同的LLM模型
- **存储扩展**: 支持不同的向量存储后端
- **缓存扩展**: 支持Redis等分布式缓存

## 监控和运维

### 性能监控
- **详细时间统计**: 每个组件的执行时间
- **缓存命中率**: 向量缓存和问答缓存的命中率
- **资源使用率**: CPU、内存、磁盘使用情况
- **错误率**: 系统错误和异常统计

### 日志管理
- **结构化日志**: 支持JSON格式日志
- **日志级别**: 支持多种日志级别
- **日志轮转**: 自动日志文件管理

### 运维工具
- **stats命令**: 系统状态查看
- **cleanup命令**: 系统清理和优化
- **optimize命令**: 性能优化和缓存预热

## 部署架构

### 单机部署
```
entrag程序 → PostgreSQL → Ollama → 本地文件系统
```

### 容器化部署
```
Docker容器 → Docker网络 → 持久化存储卷
```

### 云部署
```
云服务器 → 云数据库 → 云存储 → 云网络
```

## 未来发展方向

### 短期目标
- **分布式缓存**: 支持Redis分布式缓存
- **更多模型**: 支持更多LLM模型
- **Web界面**: 提供Web用户界面

### 长期目标
- **多模态**: 支持图像、音频等多模态数据
- **实时更新**: 支持文档实时更新和索引
- **智能推荐**: 基于用户行为的智能推荐

## 总结

Entrag通过**完整缓存系统**的引入，实现了从14秒到13毫秒的极致性能提升，成为了一个真正生产可用的RAG系统。其模块化设计、高性能缓存、并发处理和扩展性使其适合各种规模的部署场景。 