# Entrag 技术架构文档

## 系统架构概览

Entrag是一个基于RAG（检索增强生成）技术的智能问答系统，采用模块化设计，具有高可扩展性和可维护性。

## 核心组件

### 1. 应用层 (Application Layer)
- **CLI接口**: 基于Kong框架的命令行界面
- **配置管理**: YAML配置文件支持环境变量覆盖
- **命令处理**: Load、Index、Ask三个核心命令

### 2. 业务逻辑层 (Business Logic Layer)
- **文档处理**: Markdown和文本文档解析和分块
- **向量化**: 文本到向量的转换
- **检索引擎**: 基于向量相似度的语义搜索
- **生成引擎**: 基于检索结果的答案生成

### 3. 数据访问层 (Data Access Layer)
- **ORM**: Ent ORM提供类型安全的数据库操作
- **向量存储**: pgvector扩展支持向量数据操作
- **连接管理**: 数据库连接池管理

### 4. 数据存储层 (Data Storage Layer)
- **PostgreSQL**: 关系型数据库
- **pgvector**: 向量数据库扩展
- **HNSW索引**: 高效的向量检索索引

### 5. 外部服务层 (External Services Layer)
- **Ollama**: 本地LLM服务
- **嵌入模型**: nomic-embed-text等
- **聊天模型**: llama3.1等

## 数据流架构

### 文档处理流程
```
1. 文档扫描 → 2. 内容解析 → 3. 文本分块 → 4. Token计算 → 5. 数据库存储
```

### 向量化流程
```
1. 文本块获取 → 2. Ollama API调用 → 3. 向量生成 → 4. 向量存储 → 5. 索引建立
```

### 问答流程
```
1. 用户提问 → 2. 问题向量化 → 3. 向量检索 → 4. 文档片段提取 → 5. 上下文构建 → 6. LLM生成 → 7. 答案返回
```

## 技术选型

### 编程语言
- **Go**: 主要开发语言，性能优异，并发支持良好

### 数据库
- **PostgreSQL 15+**: 成熟稳定的关系型数据库
- **pgvector**: 专业的向量数据库扩展，支持多种向量操作

### ORM框架
- **Ent**: Facebook开源的Go ORM，提供：
  - 类型安全的数据库操作
  - 代码生成
  - 图查询支持
  - 迁移管理

### 向量检索
- **HNSW算法**: 分层小世界图算法，提供：
  - 高效的近似最近邻搜索
  - 可扩展的索引结构
  - 良好的查询性能

### LLM服务
- **Ollama**: 本地LLM运行环境，优势：
  - 完全本地部署
  - 数据隐私保护
  - 多模型支持
  - API兼容性好

## 安全架构

### 数据安全
- **本地部署**: 所有数据处理在本地完成，不依赖外部API
- **数据加密**: 支持数据库连接SSL加密
- **访问控制**: 基于配置文件的访问控制

### 系统安全
- **输入验证**: 严格的输入参数验证
- **SQL注入防护**: 使用参数化查询
- **错误处理**: 统一的错误处理机制

## 性能优化

### 数据库优化
- **连接池**: 配置合适的连接池大小
- **索引优化**: 为查询字段创建合适的索引
- **分页查询**: 支持大数据量的分页处理

### 向量检索优化
- **HNSW参数调优**: 针对数据集特点调整参数
- **向量维度**: 选择合适的向量维度平衡精度和性能
- **批量处理**: 支持批量向量化操作

### 内存管理
- **流式处理**: 处理大文件时使用流式读取
- **垃圾回收**: 及时释放不需要的内存资源
- **缓存策略**: 合理使用缓存减少重复计算

## 可扩展性设计

### 水平扩展
- **数据库分片**: 支持数据库水平分片
- **负载均衡**: 支持多实例负载均衡
- **分布式存储**: 支持分布式向量存储

### 垂直扩展
- **模块化设计**: 易于添加新功能模块
- **插件系统**: 支持自定义插件扩展
- **配置化**: 通过配置文件控制系统行为

## 监控与运维

### 日志系统
- **分级日志**: 支持不同级别的日志输出
- **结构化日志**: 支持JSON格式的结构化日志
- **日志轮转**: 自动日志文件轮转

### 监控指标
- **性能指标**: 响应时间、吞吐量等
- **系统指标**: CPU、内存、磁盘使用率
- **业务指标**: 查询成功率、向量化速度等

### 运维工具
- **配置管理**: 集中化配置管理
- **部署脚本**: 自动化部署脚本
- **健康检查**: 系统健康状态检查

## 部署架构

### 单机部署
```
┌─────────────────┐
│   Entrag CLI    │
├─────────────────┤
│   PostgreSQL    │
│   + pgvector    │
├─────────────────┤
│     Ollama      │
│   (LLM Models)  │
└─────────────────┘
```

### 分布式部署
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Entrag CLI    │    │   Entrag CLI    │    │   Entrag CLI    │
│   (Instance 1)  │    │   (Instance 2)  │    │   (Instance 3)  │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         └───────────────────────┼───────────────────────┘
                                 │
                    ┌─────────────────┐
                    │   Load Balancer │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │   PostgreSQL    │
                    │   + pgvector    │
                    │   (Cluster)     │
                    └─────────────────┘
                                 │
                    ┌─────────────────┐
                    │     Ollama      │
                    │   (LLM Cluster) │
                    └─────────────────┘
```

### 容器化部署
```
┌─────────────────────────────────────────────────────────────┐
│                        Docker Compose                       │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │   Entrag    │  │ PostgreSQL  │  │   Ollama    │         │
│  │ Container   │  │ + pgvector  │  │ Container   │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
├─────────────────────────────────────────────────────────────┤
│                      Docker Network                         │
└─────────────────────────────────────────────────────────────┘
```

## 故障处理

### 故障检测
- **健康检查**: 定期检查系统各组件状态
- **错误监控**: 实时监控错误率和异常
- **性能监控**: 监控系统性能指标

### 故障恢复
- **自动重试**: 针对临时性故障的自动重试机制
- **降级策略**: 在部分组件故障时的降级处理
- **备份恢复**: 数据备份和恢复策略

### 灾难恢复
- **数据备份**: 定期数据备份
- **异地容灾**: 支持异地容灾部署
- **快速恢复**: 快速恢复机制

## 开发规范

### 代码规范
- **Go代码风格**: 遵循Go官方代码风格
- **注释规范**: 完整的函数和类型注释
- **错误处理**: 统一的错误处理模式

### 测试规范
- **单元测试**: 完整的单元测试覆盖
- **集成测试**: 端到端的集成测试
- **性能测试**: 关键路径的性能测试

### 文档规范
- **API文档**: 完整的API文档
- **部署文档**: 详细的部署说明
- **运维文档**: 运维操作手册

## 技术栈总结

| 层次 | 技术选型 | 版本 | 作用 |
|------|----------|------|------|
| 应用层 | Go | 1.23+ | 主要开发语言 |
| CLI框架 | Kong | 1.8+ | 命令行界面 |
| 配置管理 | YAML | v3 | 配置文件格式 |
| ORM框架 | Ent | 0.14+ | 数据库ORM |
| 数据库 | PostgreSQL | 15+ | 关系型数据库 |
| 向量扩展 | pgvector | 0.5+ | 向量数据库 |
| LLM服务 | Ollama | Latest | 本地LLM运行环境 |
| 嵌入模型 | nomic-embed-text | Latest | 文本向量化 |
| 聊天模型 | llama3.1 | Latest | 文本生成 |
| 容器化 | Docker | 20+ | 容器部署 |
| 编排工具 | Docker Compose | 2.0+ | 容器编排 |

## 未来规划

### 功能扩展
- **多语言支持**: 支持更多编程语言的文档（已支持中英文）
- **图形界面**: 开发Web界面
- **API服务**: 提供RESTful API服务
- **插件系统**: 支持第三方插件
- **更多文件格式**: 支持PDF、Word等格式

### 性能优化
- **缓存系统**: 引入Redis缓存
- **异步处理**: 支持异步任务处理
- **GPU加速**: 支持GPU加速推理
- **分布式计算**: 支持分布式向量计算

### 运维改进
- **自动化部署**: 完全自动化的部署流程
- **监控告警**: 完善的监控告警系统
- **自动扩容**: 基于负载的自动扩容
- **故障自愈**: 自动故障检测和恢复

---

*文档版本: 1.0*
*最后更新: 2025年1月8日* 